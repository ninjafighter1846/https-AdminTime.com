<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Status Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <header class="mb-6">
      <h1 class="text-3xl font-bold mb-2">Admin Status Board</h1>
      <p class="text-slate-600">Multiple admins can add entries for being <strong>Offline</strong> or <strong>Busy</strong>.</p>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Form -->
      <section class="md:col-span-1 bg-white p-4 rounded-lg shadow">
        <h2 class="font-semibold mb-3">Create New Entry</h2>
        <form id="entryForm" class="space-y-3">
          <div>
            <label class="text-sm block mb-1">Name</label>
            <input id="name" class="w-full border rounded p-2" placeholder="Your name" required />
          </div>

          <div>
            <label class="text-sm block mb-1">Status</label>
            <select id="status" class="w-full border rounded p-2">
              <option value="Offline">Offline</option>
              <option value="Busy">Busy</option>
            </select>
          </div>

          <div>
            <label class="text-sm block mb-1">Duration</label>
            <div class="flex gap-2">
              <input id="days" type="number" min="0" value="0" class="w-1/3 border rounded p-2" placeholder="Days" />
              <input id="hours" type="number" min="0" value="0" class="w-1/3 border rounded p-2" placeholder="Hours" />
              <input id="minutes" type="number" min="0" value="30" class="w-1/3 border rounded p-2" placeholder="Minutes" />
            </div>
            <p class="text-xs text-slate-500 mt-1">The entry will be removed automatically when the time expires.</p>
          </div>

          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-blue-600 text-white rounded px-4 py-2">Submit</button>
            <button id="clearAll" type="button" class="bg-red-100 text-red-700 rounded px-4 py-2">Clear All</button>
          </div>
        </form>
      </section>

      <!-- List -->
      <section class="md:col-span-2 bg-white p-4 rounded-lg shadow">
        <h2 class="font-semibold mb-3">Current Entries</h2>
        <div id="list" class="space-y-3">
          <p class="text-slate-500">Loading entries…</p>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-sm text-slate-500">Made with ♥ for the admin team.</footer>
  </div>

  <script type="module">
    // ---------- CONFIG: replace with your Firebase config ----------
    const firebaseConfig = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME",
      projectId: "REPLACE_ME",
      storageBucket: "REPLACE_ME",
      messagingSenderId: "REPLACE_ME",
      appId: "REPLACE_ME"
    };

    // ---------- Imports (Firebase modular SDK) ----------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      deleteDoc,
      doc,
      getDocs,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // Initialize Firebase (wrapped in try/catch to show helpful error)
    let app, db;
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    } catch (e) {
      document.getElementById('list').innerHTML = '<p class="text-red-600">Failed to initialize Firebase — check configuration in the file.</p>';
      console.error('Firebase init error', e);
      throw e; // stop further execution
    }

    // Firestore logic
    const collectionName = 'admin_status';
    const colRef = collection(db, collectionName);

    const form = document.getElementById('entryForm');
    const nameInput = document.getElementById('name');
    const statusInput = document.getElementById('status');
    const daysInput = document.getElementById('days');
    const hoursInput = document.getElementById('hours');
    const minutesInput = document.getElementById('minutes');
    const listEl = document.getElementById('list');
    const clearAllBtn = document.getElementById('clearAll');

    // Format remaining time
    function formatRemaining(ms) {
      if (ms <= 0) return 'Expired';
      const totalSec = Math.floor(ms / 1000);
      const days = Math.floor(totalSec / 86400);
      const hrs = Math.floor((totalSec % 86400) / 3600);
      const mins = Math.floor((totalSec % 3600) / 60);
      const secs = totalSec % 60;
      if (days > 0) return `${days}d ${hrs}h ${mins}m`;
      if (hrs > 0) return `${hrs}h ${mins}m`;
      if (mins > 0) return `${mins}m ${secs}s`;
      return `${secs}s`;
    }

    // Keep track of countdown intervals so we can clear them when re-rendering
    const countdownIntervals = new Map();

    function renderList(docs) {
      // clear any previous intervals
      for (const iv of countdownIntervals.values()) clearInterval(iv);
      countdownIntervals.clear();

      if (!docs.length) {
        listEl.innerHTML = '<p class="text-slate-500">No entries.</p>';
        return;
      }

      listEl.innerHTML = '';
      docs.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const name = data.name || 'Unknown';
        const status = data.status || 'Offline';
        const expiresAt = data.expiresAt || null;

        const card = document.createElement('div');
        card.className = 'flex items-center justify-between border p-3 rounded';

        const left = document.createElement('div');
        left.innerHTML = `<div class="font-medium">${escapeHtml(name)}</div><div class="text-sm text-slate-500">${escapeHtml(status)}</div>`;

        const right = document.createElement('div');
        right.className = 'text-right flex items-center';

        const remainingEl = document.createElement('div');
        remainingEl.className = 'font-mono text-sm';

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'ml-3 text-xs px-2 py-1 border rounded text-red-600';
        delBtn.addEventListener('click', async () => {
          try {
            await deleteDoc(doc(db, collectionName, id));
          } catch (e) {
            console.error('Delete failed', e);
            alert('Failed to delete - check console');
          }
        });

        right.appendChild(remainingEl);
        right.appendChild(delBtn);

        card.appendChild(left);
        card.appendChild(right);
        listEl.appendChild(card);

        // Update remaining time every second; if expired, attempt cleanup
        function updateRemaining() {
          if (!expiresAt) {
            remainingEl.textContent = '—';
            return;
          }
          const rem = expiresAt - Date.now();
          if (rem <= 0) {
            remainingEl.textContent = 'Expired';
            // try to delete the document (best effort)
            deleteDoc(doc(db, collectionName, id)).catch(()=>{});
            return;
          }
          remainingEl.textContent = formatRemaining(rem);
        }

        updateRemaining();
        const iv = setInterval(updateRemaining, 1000);
        countdownIntervals.set(id, iv);
      });
    }

    // Simple HTML-escape helper
    function escapeHtml(s){
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Subscribe to realtime updates, sorted by expiresAt (soonest first)
    const q = query(colRef, orderBy('expiresAt'));
    onSnapshot(q, async (snapshot) => {
      const docs = [];
      snapshot.forEach(snap => {
        const data = snap.data();
        const expiresAt = data.expiresAt || 0;
        const id = snap.id;
        // If a document already expired, schedule it for cleanup
        if (expiresAt && expiresAt <= Date.now()) {
          deleteDoc(doc(db, collectionName, id)).catch(()=>{});
        } else {
          docs.push(snap);
        }
      });
      renderList(docs);
    }, err => {
      console.error('Error loading entries:', err);
      listEl.innerHTML = '<p class="text-red-600">Error loading entries. Check Firebase configuration and console.</p>';
    });

    // Form submit: create a new entry
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = nameInput.value.trim() || 'Unknown';
      const status = statusInput.value;
      const days = Math.max(0, Number(daysInput.value) || 0);
      const hours = Math.max(0, Number(hoursInput.value) || 0);
      const minutes = Math.max(0, Number(minutesInput.value) || 0);

      // compute duration in ms (minimum 1 minute)
      let totalMinutes = days * 24 * 60 + hours * 60 + minutes;
      if (totalMinutes <= 0) totalMinutes = 30; // default to 30 minutes
      const durationMs = totalMinutes * 60 * 1000;
      const expiresAt = Date.now() + durationMs;

      try {
        await addDoc(colRef, {
          name,
          status,
          expiresAt,
          createdAt: Date.now(),
          createdOn: serverTimestamp()
        });
        daysInput.value = '0';
        hoursInput.value = '0';
        minutesInput.value = '30';
        nameInput.value = '';
      } catch (err) {
        console.error('Failed to save', err);
        alert('Failed to save — check console.');
      }
    });

    // Clear all entries (dangerous) — reads all docs then deletes them
    clearAllBtn.addEventListener('click', async () => {
      if (!confirm('Delete all entries permanently?')) return;
      try {
        const snaps = await getDocs(colRef);
        const deletes = [];
        snaps.forEach(s => deletes.push(deleteDoc(doc(db, collectionName, s.id))));
        await Promise.all(deletes);
      } catch (e) {
        console.error('Error deleting all entries', e);
        alert('Error deleting — see console.');
      }
    });

  </script>
</body>
</html>
